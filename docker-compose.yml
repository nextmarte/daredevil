services:
  web:
    # Build local com glibc (recomendado para torch/whisper)
    build: .
    # Se preferir usar imagem UV do GHCR: comente build acima e descomente a linha abaixo
    # image: ${UV_IMAGE:-ghcr.io/astral-sh/uv:0.9.2-python3.14-alpine}
    container_name: daredevil_web
    ports:
      - "0.0.0.0:8511:8000"
    # Habilitar GPU NVIDIA
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all  # Usa todas as GPUs disponíveis (ou especifique um número)
              capabilities: [gpu]
        limits:
          memory: 16G  # Limite de memória RAM
    environment:
      - DEBUG=0
      - WHISPER_MODEL=medium
      - WHISPER_LANGUAGE=pt
      - MAX_AUDIO_SIZE_MB=500
      - TEMP_AUDIO_DIR=/tmp/daredevil
      - ALLOWED_HOSTS=*
      - PYTHONUNBUFFERED=1
      - LANGUAGE=pt_BR.UTF-8
      - LANG=pt_BR.UTF-8
      - LC_ALL=pt_BR.UTF-8
    volumes:
      - ./:/app
    working_dir: /app
    entrypoint: ["/app/docker-entrypoint.sh"]
    restart: unless-stopped
