version: '3.8'

services:
  redis:
    image: redis:7-alpine
    container_name: daredevil_redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5

  web:
    # Build local com glibc (recomendado para torch/whisper)
    build: .
    # Se preferir usar imagem UV do GHCR: comente build acima e descomente a linha abaixo
    # image: ${UV_IMAGE:-ghcr.io/astral-sh/uv:0.9.2-python3.14-alpine}
    container_name: daredevil_web
    ports:
      - "8511:8000"
    # Habilitar GPU NVIDIA
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all  # Usa todas as GPUs disponíveis (ou especifique um número)
              capabilities: [gpu]
        limits:
          memory: 16G  # Limite de memória RAM
    environment:
      - DEBUG=0
      - WHISPER_MODEL=medium
      - WHISPER_LANGUAGE=pt
      - MAX_AUDIO_SIZE_MB=500
      - TEMP_AUDIO_DIR=/tmp/daredevil
      - ALLOWED_HOSTS=*
      - PYTHONUNBUFFERED=1
      - LANGUAGE=pt_BR.UTF-8
      - LANG=pt_BR.UTF-8
      - LC_ALL=pt_BR.UTF-8
      - REDIS_URL=redis://redis:6379/0
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/0
      # ✅ NOVAS: Proteções contra travamento
      - MEMORY_CRITICAL_THRESHOLD_PERCENT=90
      - MEMORY_WARNING_THRESHOLD_PERCENT=75
      - DISK_CRITICAL_THRESHOLD_PERCENT=90
      - TEMP_DIR_MAX_SIZE_MB=5000
      - MAX_CONCURRENT_TRANSCRIPTIONS=4
      # ✨ NOVAS: Conversor remoto de áudio (host.docker.internal)
      - REMOTE_CONVERTER_URL=http://192.168.1.33:8591
      - REMOTE_CONVERTER_ENABLED=true
      - REMOTE_CONVERTER_TIMEOUT=600
      - REMOTE_CONVERTER_MAX_RETRIES=2
    volumes:
      - ./:/app
      - temp_audio:/tmp/daredevil  # ✅ NOVO: Volume compartilhado para arquivos temporários
    working_dir: /app
    entrypoint: ["/app/docker-entrypoint.sh"]
    depends_on:
      redis:
        condition: service_healthy
    restart: unless-stopped

  celery_worker:
    container_name: daredevil_celery_worker
    build:
      context: .
      dockerfile: Dockerfile
      # target: app  # Removido - Dockerfile não usa multi-stage
    image: daredevil:latest
    # ✅ CPU worker: --pool=solo é OK pois não usa GPU
    command: uv run celery -A config worker --loglevel=info --pool=solo --queues=default -n worker1@%h
    volumes:
      - ./:/app
      - temp_audio:/tmp/daredevil  # ✅ CORRIGIDO: Usar volume compartilhado
      - ~/.cache/whisper:/root/.cache/whisper
    environment:
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/0
      - DATABASE_URL=sqlite:////app/db.sqlite3
      - DJANGO_SETTINGS_MODULE=config.settings
      - PYTHONUNBUFFERED=1
      # ✅ CORRIGIDO: Usar host.docker.internal
      - REMOTE_CONVERTER_URL=http://192.168.1.33:8591
    depends_on:
      redis:
        condition: service_healthy
    restart: unless-stopped

  celery_worker_gpu1:
    image: daredevil:latest
    container_name: daredevil_celery_worker_gpu1
    restart: unless-stopped
    command: bash -c "export CUDA_VISIBLE_DEVICES=0 && exec uv run celery -A config worker --loglevel=info --pool=threads --concurrency=1 --queues=gpu -n worker_gpu1@%h"
    # ✅ CRITICO: --pool=threads evita fork que quebra CUDA
    # ✅ CUDA_VISIBLE_DEVICES=0 (você tem 1 GPU, index 0 é a primeira/única)
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1  # Usa 1 GPU específica
              capabilities: [gpu]
    volumes:
      - ./:/app
      - temp_audio:/tmp/daredevil
      - ~/.cache/whisper:/root/.cache/whisper
    environment:
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/0
      - DATABASE_URL=sqlite:////app/db.sqlite3
      - DJANGO_SETTINGS_MODULE=config.settings
      - PYTHONUNBUFFERED=1
      - REMOTE_CONVERTER_URL=http://192.168.1.33:8591
      - CUDA_VISIBLE_DEVICES=0
      - PYTHONUNBUFFERED=1
    depends_on:
      redis:
        condition: service_healthy

  celery_beat:
    build: .
    container_name: daredevil_celery_beat
    command: celery -A config beat --loglevel=info --scheduler django_celery_beat.schedulers:DatabaseScheduler
    environment:
      - DEBUG=0
      - WHISPER_MODEL=medium
      - WHISPER_LANGUAGE=pt
      - MAX_AUDIO_SIZE_MB=500
      - TEMP_AUDIO_DIR=/tmp/daredevil
      - PYTHONUNBUFFERED=1
      - LANGUAGE=pt_BR.UTF-8
      - LANG=pt_BR.UTF-8
      - LC_ALL=pt_BR.UTF-8
      - REDIS_URL=redis://redis:6379/0
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/0
      - DJANGO_SETTINGS_MODULE=config.settings
      - MEMORY_CRITICAL_THRESHOLD_PERCENT=90
      - MEMORY_WARNING_THRESHOLD_PERCENT=75
      - DISK_CRITICAL_THRESHOLD_PERCENT=90
      - TEMP_DIR_MAX_SIZE_MB=5000
      - MAX_CONCURRENT_TRANSCRIPTIONS=4
      # ✅ Usar host.docker.internal
      - REMOTE_CONVERTER_URL=http://192.168.1.33:8591
      - REMOTE_CONVERTER_ENABLED=true
      - REMOTE_CONVERTER_TIMEOUT=600
      - REMOTE_CONVERTER_MAX_RETRIES=2
    volumes:
      - ./:/app
      - temp_audio:/tmp/daredevil
    working_dir: /app
    depends_on:
      - redis
      - web
    restart: unless-stopped

volumes:
  redis_data:
  temp_audio:  # ✅ NOVO: Volume para arquivos temporários compartilhados entre containers